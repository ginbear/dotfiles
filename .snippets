# shell
exec $SHELL -l                                                               ## shell の再立ち上げと同等
lsof -i:80                                                                   ## ポート使用プロセス確認
ps ax -orss,cmd | sort -rn                                                   ## メモリを使っている順
cat hoge 2>&1 | tee result_$(hostname -s).$(date +%Y%m%d-%H%M%S).log         ## tee で結果残し
grep -v -E "^\s*#|^\s*$"                                                     ## config だけを見たいんや！
while :; do date; df ; sleep 5 ; done                                        ## 永久 Loop . Disk 容量を記録しつづける
sudo sh -c 'echo test > test.txt'                                            ## 管理者権限でファイルをリダイレクトする
ps auxwwf | grep $TARGET | awk '{print "kill ",$2}' | sudo sh                ## 特定の grep を kill
cat hoge | egrep -o '\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b' | sort -t. -k1,1n -k2,2n -k3,3n -k4,4n  ## IP アドレスだけ抽出してソートする
sudo ionice -c 2 -n 7 nice -n 19 du -scm /* | sort -rn                       ## ディスク使用量を確認
date +%Y%m%d -d '1 days ago'                                                 ## 昨日の日付
set-window-option synchronize-panes on                                       ## tmux キーブロードキャスト

# ssh
ssh -L 8443:127.0.0.1:8443 user@target-host.com                              ## ポートフォワード
ssh-keygen -l -f ~/.ssh/id_rsa.pub                                           ## 公開鍵から bit 長と種別を確認する
ssh-keygen -y -f ~/.ssh/id_rsa                                               ## 秘密鍵から公開鍵を出力する

# git
git log --oneline -10                                                        ## git log をみやすく
git diff FETCH_HEAD                                                          ## マージ前の差分チェック
git reset --soft HEAD^                                                       ## 直前の commit を取り消したい
git commit --amend -m "(新しいコミットメッセージ)"                           ## 直前のコミットログを編集する
git branch -d hoge                                                           ## ブランチ削除
git branch --merged | grep -v '*' | xargs -I % git branch -d %               ## local の不要ブランチを削除
git restore --source=HEAD^ fileA fileB                                       ## 直前のコミットから一部のファイルだけ戻したいとき
git diff --name-only abcdef12^ abcdef12                                      ## 差分からファイル名だけを表示する
git push origin HEAD                                                         ## 現行の Branch を git push
git push origin :hoge                                                        ## リモートブランチ削除
git fetch ; git merge origin/hoge                                            ## リモートブランチの更新を取り込む
git checkout -b other_branch origin/other_branch                             ## リモートブランチを取得
git reset --hard origin/<branch name>                                        ## stage を最新にする
git branch --set-upstream-to=origin/branch-name branch-name                  ## upstream 設定
git config --list --global                                                   ## git の global config を確認する
git log --graph --oneline --decorate --all -10                               ## もりもり git log
git merge FETCH_HEAD                                                         ## マージ
gh pr view -w                                                                ## PRをブラウザで開く
gh pr checks --watch                                                         ## カレントブランチのPRのCIをみる
gh pr checkout <target>                                                      ## リモートブランチをローカルチェックアウト
gh pr create --assignee @me --fill-verbose --draft && gh pr view --web       ## PR作る

# kubernetes
kubectl get pods -o wide                                                     ## pod 一覧（IP, Node 情報含む）
kubectl get all                                                              ## 全体俯瞰
kubectl logs <pod-name>                                                      ## pod ログ
kubectl describe pod <pod-name>                                              ## pod 詳細
kubectl exec -it <pod-name> -- /bin/bash                                     ## pod に入る → 関数: k-exec
kubectl top nodes                                                            ## Node ごとの負荷を見るコマンド
kubectl get ns                                                               ## namespace 一覧 → 関数: kns
kubectl config get-contexts                                                  ## context 一覧 → 関数: kctx
kubectl config use-context <context-name>                                    ## context 切り替え → 関数: kctx
kubectl config set-context --current --namespace=<namespace>                 ## namespace 設定 → 関数: kns
kubectl port-forward -n <ns> svc/<svc> 8080:8080                             ## ポートフォワード
stern <pod-regex> --container <container-name>                               ## 複数 pod のログ調査
kubectl get daemonset --all-namespaces                                       ## daemonset リスト
kubectl get replicaset --sort-by=.metadata.creationTimestamp                 ## replicaset を作成順に表示
kubectl get pods --all-namespaces --field-selector spec.nodeName=<nodename> -o wide  ## 特定 node の pod 一覧
kubectl get applications.argoproj.io -A                                      ## ArgoCD Application 一覧
kustomize build overlays/dev | yq 'select(.kind == "Ingress")'               ## kustomize で manifest 生成
kustomize build path/ | kubectl diff -f -                                    ## kustomize diff
helm list -A                                                                 ## helm リリース一覧
kubectl logs <pod> | jq -r '[(.ts | strftime("%Y-%m-%d %H:%M:%S")), .level, .msg] | @tsv' ## timesttamp 変換

# terraform
terraform plan --target=<resource>                                           ## 特定リソースのみ plan
terraform workspace list                                                     ## workspace 一覧
terraform workspace select <name>                                            ## workspace 切り替え

# openssl
openssl s_client -connect <DOMAIN>:443                                       ## SSL 接続テスト
openssl x509 -noout -modulus -in *.crt | openssl md5                         ## 証明書の md5（組み合わせ確認用）
openssl rsa  -noout -modulus -in *.key | openssl md5                         ## 秘密鍵の md5（組み合わせ確認用）
openssl req  -noout -modulus -in *.csr | openssl md5                         ## CSR の md5（組み合わせ確認用）
echo "" | openssl s_client -connect <DOMAIN>:443 -servername <SNI> -showcerts 2>&1 | grep 'Temp'  ## DH キー長確認

# linux
find ./ -daystart -ctime -2                                                  ## 2日以内に変更されたファイル
find ./ -daystart -ctime +2                                                  ## 2日より前に変更されたファイル
find . -maxdepth 1 -type f -name "*.txt" -print0 | xargs -0 rm               ## 空白含むファイル名も削除
find . -maxdepth 1 -type f \! \( -name "*.txt" -o -name "*.rb" \)            ## 特定拡張子以外を探す
sudo rsync -av --progress --bwlimit=1000 /tmp/test.txt host:/tmp/            ## 帯域制限付き rsync
pkill -STOP rsync && sleep 300 && pkill -CONT rsync &                        ## rsync 一時停止
